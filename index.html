<!DOCTYPE html>
<!--  automatic dark mode :) -->
<html data-color-mode="auto" data-dark-theme="dark" data-light-theme="light" lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="https://unpkg.com/@primer/css@^19.0.0/dist/primer.css" rel="stylesheet"/>
    <title>SteamDepotDownloaderGUI</title>
</head>
<body>
<script>
    function submitDotnet() {
        const electron = require('electron');
        const os = require('os');
        if (os.platform().includes("win")) {
            console.log('Opened .NET download page for ' + os.platform().charAt(0).toUpperCase() + os.platform().slice(1))
            electron.shell.openExternal('https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.301-windows-x64-installer')
        }
        if (os.platform().includes("linux")) {
            console.log('Opened .NET download page for ' + os.platform().charAt(0).toUpperCase() + os.platform().slice(1))
            electron.shell.openExternal('https://docs.microsoft.com/en-us/dotnet/core/install/linux')
        }
        if (os.platform().includes("darwin")) {
            console.log('Opened .NET download page for' + os.platform())
            //TODO: apple silicon(ARM64) URL
            electron.shell.openExternal('https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.301-macos-x64-installer')
        }

    }
    function submitForm() {
        const os = require('os');
        const fs = require('fs');
        const path = require('path').dirname(__filename);
        const which = require('which')

        //TODO: Test compatiblity on Linux, macOS and windows
        document.getElementById("download").disabled = true;
        let spawn = require("child_process").spawn;

        let username = document.forms["theform"]["username"].value;
        let password = document.forms["theform"]["password"].value;
        let appid = document.forms["theform"]["appid"].value;
        let depotid = document.forms["theform"]["depotid"].value;
        let manifestid = document.forms["theform"]["manifestid"].value;
        console.debug(
            "DEBUG INFO\n"
            + "Username: " + username
            + "\nPassword: no"
            + "\nApp ID: " + appid +
            "\nDepot ID: " + depotid
            + "\nManifest ID: " + manifestid
            + "\nPlatform: " + os.platform()
            + "\nPath: " + path
        );
        if (os.platform().includes("win")) {
            console.log("Using Windows!")
        }
        if (os.platform().includes("linux")) {
            console.log("Using Linux")
            console.log(path)
            try {
                // first check if directory already exists
                if (!fs.existsSync("./depotdownloader")) {
                    fs.mkdirSync("./depotdownloader");
                    console.log("Directory is created.");
                } else {
                    console.log("Directory already exists.");
                }
            } catch (err) {
                console.log(err);
            }
            const fetchData = url => new Promise((res, rej) => {
                const https = require("https")
                const request = https.request(url, response => {
                    let data = ""
                    response.on("data", chunk => {
                        data += chunk.toString()
                    })
                    response.on("end", () => {
                        res(data)
                    })
                })
                request.on("error", err => rej(err))
                request.end()
            })
            fetchData('https://pastebin.com/raw/Gh46mhfM').then(res => {
                console.log(res.toString())
                fs.writeFile((path + '/depotdownloader/test.txt'), res, function (err) {
                    if (err) {
                        return console.log(err);
                    }
                    console.log("The file was saved!");
                })
            })
            which('dotnet', function (er) {
                // er is returned if no "node" is found on the PATH
                // if it is found, then the absolute path to the exec is returned
                if (er) {
                    console.log("dotnet not found")
                    document.getElementById('alert').hidden = false
                    document.getElementById('alertbtn').hidden = false
                    return
                } else {
                    console.log("dotnet found")
                }
            })
            console.log("this should not be printed")
        }
    }

</script>
<div class="flash  flash-error mx-4 mt-2 mb-2" id="alert" hidden>
    <svg class="octicon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <code>dotnet</code> was not found.
    <button class="btn btn-sm flash-action" type="submit" id="alertbtn" hidden onclick="submitDotnet()">
        <svg class="octicon" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.47 10.78a.75.75 0 001.06 0l3.75-3.75a.75.75 0 00-1.06-1.06L8.75 8.44V1.75a.75.75 0 00-1.5
         0v6.69L4.78 5.97a.75.75 0 00-1.06 1.06l3.75 3.75zM3.75 13a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5z"
                  fill-rule="evenodd"></path>
        </svg>
        Download<br>
    </button>
</div>
<div style="text-align: center;" class="h2-mktg">Steam Depot Downloader</div>
<form id="theform">
    <div class="form-group mx-3">
        <div class="form-group-header">
            <label for="username">Username</label>
        </div>
        <div class="form-group-body">
            <input aria-label="Repository description" class="form-control" id="username" placeholder="Username"
                   type="text"/>
        </div>
        <br>
        <div class="form-group-header">
            <label for="password">Password</label>
        </div>
        <div class="form-group-body">
            <input aria-label="Repository description" class="form-control" id="password" placeholder="Password"
                   type="password"/>
        </div>
        <br>
        <div class="form-group-header">
            <label for="appid">App ID</label>
        </div>
        <div class="form-group-body">
            <input aria-label="Repository description" class="form-control" id="appid" placeholder="App ID"
                   type="number"/>
        </div>
        <br>
        <div class="form-group-header">
            <label for="depotid">Depot ID</label>
        </div>
        <div class="form-group-body">
            <input aria-label="Repository description" class="form-control" id="depotid" placeholder="Depot ID"
                   type="number"/>
        </div>
        <br>
        <div class="form-group-header">
            <label for="manifestid">Manifest ID</label>
        </div>
        <div class="form-group-body">
            <input aria-label="Repository description" class="form-control" id="manifestid" placeholder="Manifest ID"
                   type="number"/>
        </div>
    </div>
</form>

<button class="btn btn-primary btn-block col-11 p-2 mx-auto position-absolute bottom-3 left-3" id="download" onclick="submitForm()">
    Download
    <svg class="octicon" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.47 10.78a.75.75 0 001.06 0l3.75-3.75a.75.75 0 00-1.06-1.06L8.75 8.44V1.75a.75.75 0 00-1.5
         0v6.69L4.78 5.97a.75.75 0 00-1.06 1.06l3.75 3.75zM3.75 13a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5z"
              fill-rule="evenodd"></path>
    </svg>
</button>
</body>
</html>
